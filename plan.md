以下は、これまでの検討内容と「手書きノート永久保存プロジェクト」の仕様を整理した **Markdown仕様書** です。
将来的にREADMEや設計書としても利用できる構成になっています。

---

# 📘 手書きノート永久保存プロジェクト仕様書

## 概要

150冊ほどの手書きB6ノート（各40ページ程度）を、
**iPhoneで撮影 → OCR処理 → テキスト検索可能なPDFとして保存** するプロジェクト。
長期保存と将来の再利用（AIによる検索・解析）を目的とする。

---

## 🎯 プロジェクト目標

| 項目    | 内容                           |
| ----- | ---------------------------- |
| 主目的   | 手書きノートをデジタル化して検索可能にする        |
| 保存形式  | 1冊＝1ファイルの検索可能PDF（画像＋OCRテキスト） |
| 処理方式  | ローカルOCRを基本、クラウドOCRを補助的に利用    |
| 将来対応  | 新しいOCR技術登場時に再処理可能な構成を維持      |
| データ構成 | フォルダ単位でノートを管理（再処理しやすく）       |

---

## 📸 入力データ仕様

| 項目     | 内容                                            |
| ------ | --------------------------------------------- |
| 入力媒体   | 手書きノート（B6サイズ）                                 |
| 撮影方法   | iPhone 17 カメラ（非破壊スキャン）                        |
| 撮影ファイル | JPEG / HEIC 形式（1冊ごとにフォルダ分け）                   |
| 例      | `Notebooks/ノート01/IMG_0001.jpg … IMG_0040.jpg` |

---

## 🧰 使用ツールと環境

| カテゴリ      | ツール / ライブラリ                                            | 用途                            |
| --------- | ------------------------------------------------------ | ----------------------------- |
| OCR（ローカル） | **Tesseract + ocrmypdf**                               | 無料・オープンソースOCR、PDF内に透明テキスト埋め込み |
| OCR（クラウド） | **Google Document AI**（またはAzure Document Intelligence） | 手書き・図表含む高精度OCR、必要箇所のみ補助的に利用   |
| PDF生成     | **img2pdf / ImageMagick / プレビュー.app**                  | 画像を結合して1冊のPDFを生成              |
| OS        | macOS (brew + Python3 環境)                              | 自動処理・スクリプト実行環境                |

---

## ⚙️ 処理フロー

### ① 撮影・転送

* iPhoneでノートを撮影（照明・傾き・影を整える）
* 1冊ごとにフォルダにまとめ、MacへAirDropまたはiCloud転送

### ② PDF結合（シェルスクリプト）

```bash
img2pdf "$INPUT_DIR"/*.jpg -o "$OUTPUT_PDF"
```

### ③ ローカルOCR付与

```bash
ocrmypdf --language jpn+eng --deskew --rotate-pages "$OUTPUT_PDF" "$OUTPUT_OCR"
```

### ④ クラウドOCR補助（必要に応じて）

```bash
python ocr_cloud.py Notebooks/ノート01_ocr.pdf
```

### ⑤ 保存・バックアップ

* `ノート01_ocr.pdf` … 検索可能PDF（画像＋OCRテキスト）
* `ノート01_raw.pdf` … OCR未処理の「生」PDF（再処理用）
* `ノート01_text.json` … クラウドOCRテキストデータ（AI解析用）

---

## 🧠 クラウドOCR利用の方針

| 項目     | 内容                                    |
| ------ | ------------------------------------- |
| 利用目的   | 図や特殊記号を含むページの高精度再処理                   |
| コスト目安  | 約 $1.5 / 1,000ページ（Google Document AI） |
| 処理方式   | 手動 or 信頼度スコアによる再処理スクリプト               |
| プライバシー | 手書きノート内容を外部送信するため限定利用                 |

---

## 📂 フォルダ構成（推奨）

```
Notebooks/
├─ ノート01/
│   ├─ IMG_0001.jpg
│   ├─ IMG_0002.jpg
│   ├─ ...
│   ├─ ノート01.pdf             ← 結合画像PDF
│   ├─ ノート01_ocr.pdf         ← 検索可能PDF
│   ├─ ノート01_text.json       ← クラウドOCRテキスト
│   └─ meta.yaml                ← メモやタグ等（任意）
├─ ノート02/
│   ├─ ...
└─ scripts/
    ├─ make_pdf.sh
    ├─ ocr_cloud.py
    └─ batch_run.sh
```

---

## 🧩 自動処理スクリプト概要

### make_pdf.sh

1冊フォルダを引数に受け取り、画像→PDF→OCR済PDFを生成。

```bash
ocrmypdf --language jpn+eng --deskew --rotate-pages "$OUTPUT_PDF" "$OUTPUT_OCR"
```

### ocr_cloud.py

Google Document AI APIを呼び出し、JSON形式でテキスト抽出。

### batch_run.sh

全ノートフォルダを順次処理するループスクリプト。

```bash
for d in Notebooks/*; do
  if [ -d "$d" ]; then
    sh scripts/make_pdf.sh "$d"
  fi
done
```

---

## 🔒 データ保全と再処理方針

* **画像付きPDF**を「一次データ」として必ず残す（再OCR可能にする）。
* OCR結果テキストは別途保存（再解析・AI連携用）。
* PDFにはOCRテキストレイヤーを埋め込み → macOS / iPhone上でも検索可能。
* クラウドOCRは部分利用（品質向上 or AI分析時のみ）。

---

## 💡 今後の発展

* AI（LLM）によるノート検索・要約（Document AI → RAG構築）
* OCR品質ログの自動収集と再処理優先順位付け
* JSONメタデータ（タグ・テーマ）による知識ベース化

---

---

## 📱 iPhone 17撮影の技術基準

### 撮影設定（推奨）

| 項目 | 設定値 | 理由 |
|------|--------|------|
| **解像度** | **24MP（推奨）または12MP（デフォルト）** | 24MPで838DPI、12MPで419DPIとOCR基準を上回る |
| **フォーマット** | **HEIF（デフォルト）** | ファイルサイズと品質のバランスが良い |
| **フォーカス** | **マニュアルフォーカス** | 手書き文字の鮮明さを最優先 |
| **照明** | **均一な自然光またはLED照明** | 影や反射を最小限に抑制 |

**解像度選択の指針：**
- **12MP（デフォルト）**: ファイルサイズ小、419DPIで十分なOCR品質
- **24MP**: 高品質重視、838DPIで将来のOCR技術にも対応
- **48MP**: 最高品質、1,117DPIで完全な将来対応

### DPI計算と品質基準

**B6ノート（182×128mm）での計算：**
```
48MP（8000×6000ピクセル）の場合：
- 横方向 DPI = 8000 ÷ (182mm ÷ 25.4mm/inch) ≈ 1,117 DPI
- 縦方向 DPI = 6000 ÷ (128mm ÷ 25.4mm/inch) ≈ 1,192 DPI
```

**OCR品質基準：**
- **最低基準**: 300 DPI（一般的なOCR精度）
- **推奨基準**: 400-500 DPI（高精度OCR）
- **最適基準**: 600 DPI以上（手書き文字・図表対応）

### ファイルフォーマット戦略

| 用途 | フォーマット | 圧縮設定 | ファイルサイズ目安 |
|------|-------------|----------|-------------------|
| **保存用** | **HEIF Max** | 可逆圧縮 | 8-12MB/画像 |
| **バックアップ** | **TIFF** | 非圧縮 | 15-20MB/画像 |
| **処理用** | **JPEG** | 品質95% | 5-8MB/画像 |

### 将来のOCR再処理のための技術基準

1. **元画像の完全保存**
   - HEIF Max形式での非破壊保存
   - メタデータ（撮影日時、カメラ設定）の保持
   - ファイル整合性チェック（MD5ハッシュ）

2. **処理履歴の記録**
   ```yaml
   # meta.yaml の拡張例
   processing_history:
     - date: "2024-01-15"
       ocr_engine: "Tesseract 5.3.0"
       confidence: 85.2
       language: "jpn+eng"
     - date: "2025-03-20"
       ocr_engine: "GPT-Vision 2.0"
       confidence: 94.7
       language: "jpn+eng+math"
   ```

3. **品質評価基準**
   - **文字認識精度**: 95%以上を目標
   - **レイアウト保持**: 元の構造を維持
   - **図表認識**: 手書き図形の正確な抽出

### ストレージ容量の計算

**150冊のノート（各40ページ）での容量計算：**

| 解像度 | ファイルサイズ/画像 | 総容量 | 推奨用途 |
|--------|-------------------|--------|----------|
| **12MP（デフォルト）** | 4MB | **24GB** | 日常的な処理 |
| **24MP（推奨）** | 7MB | **42GB** | 高品質重視 |
| **48MP** | 11MB | **66GB** | 将来対応重視 |

```
追加ファイル：
処理済みPDF: 2MB × 150冊 = 300MB
OCRテキスト: 100KB × 150冊 = 15MB
バックアップ（TIFF）: 上記の約1.5倍

総容量（24MP推奨）: 約63GB（安全マージン含む）
```

---

## ✅ 現時点の結論

* メイン形式：**検索可能PDF（画像＋OCRテキスト）**
* 基盤OCR：**Tesseract + ocrmypdf（ローカル処理）**
* 補助OCR：**Google Document AI（必要部分のみ）**
* 保存方針：**非破壊撮影・1冊＝1フォルダ・再処理可能設計**
* **撮影品質：48MP HEIF Max、1000+ DPI確保**
* **将来対応：元画像完全保存、処理履歴記録、品質評価基準**
